<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
    <title>Order Entry Dashboard</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <style>
        .app-shell{
            display:flex;
            min-height:100vh;
        }

        .sidebar{
            width:240px;
            background:linear-gradient(180deg, #132a63, #1f3c88);
            color:#fff;
            padding:20px 16px;
            position:sticky;
            top:0;
            height:100vh;
            transition:transform 0.2s ease, width 0.2s ease, padding 0.2s ease;
        }

        .sidebar.collapsed{
            transform:translateX(-100%);
            width:0;
            padding:0;
            overflow:hidden;
        }

        .sidebar .brand{
            font-weight:800;
            font-size:16px;
            letter-spacing:0.4px;
            margin-bottom:18px;
        }

        .sidebar .brand span{
            display:block;
            font-weight:400;
            font-size:11px;
            color:rgba(255,255,255,0.7);
            margin-top:4px;
        }

        .nav{
            display:flex;
            flex-direction:column;
            gap:8px;
        }

        .nav-link{
            color:#e9efff;
            text-decoration:none;
            font-size:13px;
            padding:10px 12px;
            border-radius:10px;
            background:rgba(255,255,255,0.08);
        }

        .nav-link:hover{
            background:rgba(255,255,255,0.16);
        }

        .logout-form{
            margin-top:18px;
        }

        .logout-btn{
            width:100%;
            padding:10px 12px;
            border-radius:10px;
            border:none;
            background:#f97316;
            color:#fff;
            font-weight:700;
            cursor:pointer;
        }

        .app-content{
            flex:1;
            padding:24px;
        }

        .hamburger{
            position:fixed;
            top:16px;
            left:16px;
            z-index:1300;
            width:40px;
            height:40px;
            border-radius:10px;
            border:none;
            background:#1f3c88;
            color:#fff;
            font-weight:700;
            cursor:pointer;
            box-shadow:0 10px 20px rgba(12, 31, 63, 0.18);
        }

        :root{
            --bg:#f5f7fb;
            --panel:#ffffff;
            --ink:#0f1b2d;
            --muted:#5c6b7a;
            --primary:#1f5fbf;
            --primary-deep:#174a92;
            --accent:#0aa6a6;
            --accent-soft:#e6f6f6;
            --line:#e5ebf3;
            --shadow:0 18px 36px rgba(12, 31, 63, 0.10);
            --success:#1e8e5a;
            --warn:#d4911c;
            --danger:#c0362c;
            --folder:#f1f5fb;
        }

        *{box-sizing:border-box;}

        body{
            margin:0;
            font-family:"Poppins","Segoe UI",Tahoma,sans-serif;
            color:var(--ink);
            background:
                radial-gradient(circle at 10% 10%, rgba(31,95,191,0.08), transparent 45%),
                radial-gradient(circle at 90% 20%, rgba(30,142,90,0.08), transparent 40%),
                var(--bg);
            min-height:100vh;
        }

        .page{
            max-width:1200px;
            margin:24px auto 60px;
            padding:0 20px;
        }

        .header{
            display:grid;
            grid-template-columns:1fr auto 1fr;
            align-items:center;
            gap:12px;
            background:var(--panel);
            border:1px solid var(--line);
            border-radius:16px;
            padding:16px 18px;
            box-shadow:var(--shadow);
        }

        .header .left,
        .header .right{
            display:flex;
            gap:10px;
        }

        .header .right{
            justify-content:flex-end;
        }

        .profile{
            position:relative;
        }

        .profile-btn{
            border:none;
            background:transparent;
            padding:0;
            cursor:pointer;
        }

        .avatar{
            width:36px;
            height:36px;
            border-radius:50%;
            background:linear-gradient(135deg, #cfe4ff, #9bc3ff);
        }

        .profile-menu{
            position:absolute;
            right:0;
            top:46px;
            background:#fff;
            border:1px solid var(--line);
            border-radius:12px;
            box-shadow:0 14px 28px rgba(12, 31, 63, 0.14);
            display:none;
            min-width:160px;
            z-index:5;
        }

        .profile-menu button{
            width:100%;
            border:none;
            background:transparent;
            padding:10px 12px;
            text-align:left;
            font-size:12px;
            color:var(--ink);
            cursor:pointer;
        }
        .profile-menu form{
            margin:0;
        }

        .profile-menu button:hover{
            background:#f4f7fb;
        }

        .logout{
            color:#c0362c;
        }

        .title{
            text-align:center;
        }

        .title h1{
            margin:0;
            font-size:20px;
            font-weight:700;
            color:var(--primary-deep);
        }

        .title p{
            margin:4px 0 0;
            font-size:12px;
            color:var(--muted);
        }

        .btn{
            border:none;
            padding:10px 16px;
            border-radius:10px;
            font-weight:600;
            font-size:13px;
            cursor:pointer;
            display:inline-flex;
            align-items:center;
            gap:8px;
        }

        .btn-primary{
            background:linear-gradient(135deg, var(--primary), var(--primary-deep));
            color:#fff;
        }

        .btn-ghost{
            background:#eef3fb;
            color:var(--primary-deep);
        }


        .section{
            margin-top:20px;
            background:var(--panel);
            border:1px solid var(--line);
            border-radius:16px;
            padding:18px;
            box-shadow:var(--shadow);
        }

        .section-header{
            display:flex;
            justify-content:space-between;
            align-items:center;
            gap:12px;
        }

        .section-header h2{
            margin:0;
            font-size:16px;
            display:flex;
            align-items:center;
            gap:10px;
        }

        .hint{
            font-size:12px;
            color:var(--muted);
        }

        .section-header .tag{
            display:inline-flex;
            align-items:center;
            gap:6px;
            padding:6px 10px;
            border-radius:999px;
            background:#eef3fb;
            border:1px solid rgba(31,95,191,0.2);
            color:var(--primary-deep);
            font-weight:600;
            font-size:11px;
        }

        .icon{
            width:16px;
            height:16px;
            fill:currentColor;
            display:block;
        }

        .btn-icon{
            width:16px;
            height:16px;
            fill:currentColor;
            flex:0 0 auto;
        }

        .title-icon{
            width:30px;
            height:30px;
            border-radius:10px;
            display:inline-flex;
            align-items:center;
            justify-content:center;
            color:#fff;
            background:linear-gradient(135deg, #1f5fbf, #3b82f6);
            box-shadow:0 10px 20px rgba(31,95,191,0.22);
            flex:0 0 auto;
        }

        .title-icon.secondary{
            background:linear-gradient(135deg, #10b981, #34d399);
            box-shadow:0 10px 20px rgba(16,185,129,0.22);
        }

        .section-surface{
            margin-top:12px;
            padding:16px;
            border-radius:14px;
            background:linear-gradient(135deg, #f8fbff, #f3f7ff);
            border:1px solid #e3ebf7;
        }

        .section-title{
            display:flex;
            align-items:center;
            gap:10px;
            margin-bottom:10px;
            font-weight:700;
            color:var(--primary-deep);
        }

        .section-title .dot{
            width:10px;
            height:10px;
            border-radius:50%;
            background:var(--primary);
            box-shadow:0 0 0 4px rgba(31,95,191,0.12);
        }

        .empty-state{
            padding:24px;
            border-radius:12px;
            border:1px dashed var(--line);
            background:#f8faff;
            text-align:center;
            color:var(--muted);
            font-size:13px;
        }

        .table-wrap{
            overflow:auto;
            border-radius:12px;
            border:1px solid var(--line);
            margin-top:12px;
        }

        .drawer-backdrop{
            position:fixed;
            inset:0;
            background:rgba(10, 21, 40, 0.35);
            opacity:0;
            pointer-events:none;
            transition:opacity 0.2s ease;
            z-index:30;
        }

        .drawer{
            position:fixed;
            top:0;
            right:-460px;
            width:420px;
            height:100%;
            background:var(--panel);
            box-shadow:-18px 0 40px rgba(12, 31, 63, 0.18);
            padding:22px;
            transition:right 0.25s ease;
            z-index:40;
            overflow:auto;
        }

        .drawer.open{
            right:0;
        }

        .drawer-backdrop.open{
            opacity:1;
            pointer-events:auto;
        }

        .drawer h3{
            margin:0 0 6px;
            font-size:18px;
        }

        .drawer .sub{
            margin:0 0 16px;
            font-size:12px;
            color:var(--muted);
        }

        .form-card{
            border:1px solid var(--line);
            border-radius:14px;
            padding:16px;
            background:#f9fbff;
        }

        .field-grid{
            display:grid;
            grid-template-columns:repeat(2, minmax(0, 1fr));
            gap:12px;
        }

        .field{
            display:flex;
            flex-direction:column;
            gap:6px;
        }

        .field label{
            font-size:12px;
            color:var(--muted);
            font-weight:600;
        }

        .field input,
        .field select{
            padding:10px 12px;
            border-radius:10px;
            border:1px solid var(--line);
            font-size:13px;
            outline:none;
            background:#fff;
        }

        .field input:focus,
        .field select:focus{
            border-color:var(--primary);
            box-shadow:0 0 0 3px rgba(31,95,191,0.12);
        }

        .readonly{
            background:#f0f3f9;
            color:#4a5a6d;
        }

        .drawer-actions{
            display:flex;
            gap:10px;
            margin-top:16px;
        }

        .drawer-actions .btn{
            flex:1;
        }

        .success{
            display:none;
            margin-top:14px;
            padding:12px 14px;
            border-radius:12px;
            background:#e9f7ef;
            color:#186e45;
            font-size:12px;
            border:1px solid #c8ecd8;
        }

        table{
            width:100%;
            border-collapse:collapse;
            font-size:13px;
            min-width:720px;
        }

        thead th{
            position:sticky;
            top:0;
            background:#f2f6fb;
            text-align:left;
            padding:12px 14px;
            border-bottom:1px solid var(--line);
            color:#2a3b52;
            z-index:2;
        }

        tbody td{
            padding:12px 14px;
            border-bottom:1px solid #eef2f6;
            vertical-align:middle;
        }

        tbody tr{
            background:var(--panel);
        }

        tbody tr:hover{
            background:#f8fbff;
        }

        .folder-row{
            cursor:pointer;
            position:relative;
        }

        .folder-row::before{
            content:"";
            position:absolute;
            left:0;
            top:0;
            bottom:0;
            width:6px;
            background:var(--folder);
        }

        .status{
            font-weight:700;
            font-size:12px;
            padding:4px 10px;
            border-radius:999px;
            display:inline-block;
        }

        .status.green{background:#e6f6ee; color:var(--success);}
        .status.yellow{background:#fff2db; color:var(--warn);}
        .status.red{background:#fde7e7; color:var(--danger);}

        .details{
            margin-top:16px;
            padding:16px;
            border-radius:14px;
            border:1px solid var(--line);
            background:linear-gradient(135deg, #f9fbff, #f3f7ff);
        }

        .details h3{
            margin:0 0 8px;
            font-size:15px;
        }

        .details-grid{
            display:grid;
            grid-template-columns:repeat(auto-fit, minmax(200px, 1fr));
            gap:10px;
            font-size:12px;
            color:var(--muted);
        }

        .details-grid span{
            display:block;
            margin-top:4px;
            font-weight:600;
            color:var(--ink);
        }

        .details-grid input{
            width:100%;
            padding:10px 12px;
            border-radius:10px;
            border:1px solid var(--line);
            font-size:13px;
            outline:none;
            background:#fff;
            color:var(--ink);
        }

        .details-grid input:focus{
            border-color:var(--primary);
            box-shadow:0 0 0 3px rgba(31,95,191,0.12);
        }

        .planning-table{
            background:#fff;
            border-radius:12px;
            overflow:hidden;
        }
        .planning-table th,
        .planning-table td{
            text-align:left;
        }

        .planning-grid{
            table-layout:fixed;
        }

        .planning-grid thead tr,
        .planning-grid tbody tr{
            display:grid;
            grid-template-columns: 1.6fr 1fr 1fr;
            align-items:center;
        }

        .planning-grid th,
        .planning-grid td{
            display:block;
        }

        .planning-table thead th{
            background:linear-gradient(90deg, #f1f6ff, #eef4ff);
            color:#243855;
        }

        .planning-table tbody tr:nth-child(even){
            background:#fbfdff;
        }

        .planning-table .status{
            box-shadow:0 8px 16px rgba(31,95,191,0.08);
        }

        .order-entry-table thead th{
            background:linear-gradient(90deg, #f3f7ff, #f8fbff);
        }

        .planning-block{
            border:2px solid #111;
            background:linear-gradient(180deg, #ffffff, #f7f9ff);
        }

        .status-form{
            margin:0;
        }

        .status-select{
            padding:6px 10px;
            border-radius:999px;
            border:1px solid #d6deea;
            background:#fff;
            font-size:12px;
            font-weight:600;
            color:#1f3c88;
            cursor:pointer;
        }

        .folder-btn{
            width:100%;
            display:flex;
            align-items:center;
            justify-content:space-between;
            gap:12px;
            padding:12px 14px;
            border-radius:12px;
            border:1px solid #d6deea;
            background:linear-gradient(135deg, #f7faff, #eef5ff);
            font-weight:600;
            color:#1f3c88;
            cursor:pointer;
        }

        .folder-btn .left{
            display:flex;
            align-items:center;
            gap:10px;
        }

        .folder-btn .badge{
            font-size:11px;
            padding:4px 8px;
            border-radius:999px;
            background:#e6f6f6;
            color:#176b7a;
        }

        .responsible-select{
            width:100%;
            padding:8px 10px;
            border-radius:10px;
            border:1px solid #d6deea;
            background:#fff;
            font-size:12px;
            font-weight:600;
            color:#1b2b40;
        }

        .target-date-input{
            width:100%;
            padding:8px 10px;
            border-radius:10px;
            border:1px solid #d6deea;
            font-size:12px;
        }

        .target-date-input[disabled]{
            background:#f0f3f9;
            color:#4a5a6d;
        }



        .kpi-grid{
            display:grid;
            grid-template-columns:repeat(auto-fit, minmax(220px, 1fr));
            gap:16px;
            margin:14px 0 18px;
        }

        .kpi-card{
            border-radius:16px;
            padding:16px 18px;
            color:#0f1b2d;
            box-shadow:var(--shadow);
            border:1px solid rgba(255,255,255,0.6);
            position:relative;
            overflow:hidden;
        }

        .kpi-card::after{
            content:"";
            position:absolute;
            right:-30px;
            top:-30px;
            width:90px;
            height:90px;
            border-radius:50%;
            opacity:0.25;
            background:#fff;
        }

        .kpi-card h4{
            margin:0 0 8px;
            font-size:12px;
            letter-spacing:0.4px;
            text-transform:uppercase;
            color:rgba(15, 27, 45, 0.65);
        }

        .kpi-card .value{
            font-size:26px;
            font-weight:700;
        }

        .kpi-blue{
            background:linear-gradient(135deg, #d9e8ff, #f3f7ff);
        }

        .kpi-green{
            background:linear-gradient(135deg, #daf4e4, #f3fbf7);
        }

        .kpi-amber{
            background:linear-gradient(135deg, #ffe5bf, #fff7e8);
        }

        @media (max-width: 980px){
            .header{
                grid-template-columns:1fr;
                text-align:left;
            }
            .header .left,
            .header .right{
                justify-content:flex-start;
            }
            .title{
                text-align:left;
            }
            .drawer{
                width:100%;
            }
        }

        @media (max-width: 720px){
            .field-grid{
                grid-template-columns:1fr;
            }
            .drawer-actions{
                flex-direction:column;
            }
        }
    </style>
</head>
<body>

<div class="app-shell">
    <main class="app-content">
<div class="page">
    <input id="savedFlag" type="hidden" th:value="${saved}">
    <input id="savedFolderId" type="hidden" th:value="${selectedFolderId}">
    <div class="header">
        <div class="left">
            <button class="btn btn-ghost" onclick="showPlanning()">
                <svg class="btn-icon" viewBox="0 0 24 24" aria-hidden="true">
                    <path d="M12 2a10 10 0 1 0 10 10A10 10 0 0 0 12 2Zm3.7 6.3-2.1 5.7-5.7 2.1 2.1-5.7Z"/>
                </svg>
                Production Planning
            </button>
        </div>
        <div class="title">
            <h1>Order Entry Dashboard</h1>
            <p>Modern corporate ERP for O2D order creation and planning</p>
        </div>
        <div class="right">
            <button class="btn btn-primary" type="button" onclick="openDrawer()">
                <svg class="btn-icon" viewBox="0 0 24 24" aria-hidden="true">
                    <path d="M12 5a1 1 0 0 1 1 1v5h5a1 1 0 1 1 0 2h-5v5a1 1 0 1 1-2 0v-5H6a1 1 0 1 1 0-2h5V6a1 1 0 0 1 1-1z"/>
                </svg>
                New Order Entry
            </button>
            <div class="profile">
                <button class="profile-btn" type="button" onclick="toggleProfileMenu('profileMenuOrder')">
                    <div class="avatar"></div>
                </button>
                <div id="profileMenuOrder" class="profile-menu">
                    <button type="button" onclick="editProfile()">Edit Profile</button>
                    <form method="post" action="/logout" onsubmit="return confirm('Are you sure you want to logout?')">
                        <button class="logout" type="submit">Logout</button>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <div id="orderEntryView" class="section">
        <div class="section-header">
            <h2>
                <span class="title-icon">
                    <svg class="icon" viewBox="0 0 24 24" aria-hidden="true">
                        <path d="M7 3h7l5 5v13a1 1 0 0 1-1 1H7a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2Zm7 1.5V9h4.5L14 4.5ZM8 12h8v2H8v-2Zm0 4h8v2H8v-2Z"/>
                    </svg>
                </span>
                Order Entry Workspace
            </h2>
            <div class="tag">
                <svg class="icon" viewBox="0 0 24 24" aria-hidden="true">
                    <path d="M12 2a9 9 0 1 0 9 9 9 9 0 0 0-9-9Zm4.1 7.6-4.6 5a1 1 0 0 1-1.5.1l-2.1-2.1a1 1 0 1 1 1.4-1.4l1.4 1.4 3.9-4.2a1 1 0 1 1 1.5 1.2Z"/>
                </svg>
                New Orders
            </div>
        </div>
        <div class="kpi-grid">
            <div class="kpi-card kpi-blue">
                <h4>Total Orders</h4>
                <div class="value" th:text="${totalOrders}">0</div>
            </div>
            <div class="kpi-card kpi-green">
                <h4>Completed Planning</h4>
                <div class="value" th:text="${completedOrders}">0</div>
            </div>
            <div class="kpi-card kpi-amber">
                <h4>Pending Planning</h4>
                <div class="value" th:text="${pendingOrders}">0</div>
            </div>
        </div>
        <div class="table-wrap order-entry-table" style="margin-top:16px;" th:if="${orderEntries != null and !orderEntries.isEmpty()}">
            <table>
                <thead>
                    <tr>
                        <th>SR</th>
                        <th>Order ID</th>
                        <th th:each="detail : ${orderDetails}" th:text="${detail}">Detail</th>
                        <th>Planning Status</th>
                    </tr>
                </thead>
                <tbody>
                    <tr th:each="row : ${orderEntryRows}">
                        <td th:text="${row['sr']}">1</td>
                        <td th:text="${row['orderId']}">O2D-0000</td>
                        <td th:each="val : ${row['values']}" th:text="${val}">-</td>
                        <td>
                            <form class="status-form" method="post" action="/order/planning-status">
                                <input type="hidden" name="entryId" th:value="${row['entryId']}">
                                <input type="hidden" name="folderId" th:value="${selectedFolderId}">
                                <select class="status-select" name="planningStatus" onchange="this.form.submit()">
                                    <option value="Pending" th:selected="${row['planningStatus']} == 'Pending'">Pending</option>
                                    <option value="Planned" th:selected="${row['planningStatus']} == 'Planned'">Planned</option>
                                </select>
                            </form>
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>

    <div id="configData" style="display:none;"
         th:attr="data-order-id=${configOrderId},
                  data-customer-name=${configCustomerName},
                  data-company-name=${configCompanyName},
                  data-raw-material=${configRawMaterial},
                  data-quantity=${configQuantity},
                  data-cdd=${configCDD},
                  data-mpd=${configMPD},
                  data-start-date=${configStartDate}">
    </div>

    <div id="planningView" class="section" style="display:none;">
        <div class="section-header">
            <h2>
                <span class="title-icon secondary">
                    <svg class="icon" viewBox="0 0 24 24" aria-hidden="true">
                        <path d="M12 2a10 10 0 1 0 10 10A10 10 0 0 0 12 2Zm-1 5h2v5.2l3.3 1.9-1 1.8L11 13.4Z"/>
                    </svg>
                </span>
                Production Planning
            </h2>
            <div class="tag">
                <svg class="icon" viewBox="0 0 24 24" aria-hidden="true">
                    <path d="M4 6h6v2H4V6Zm0 5h10v2H4v-2Zm0 5h14v2H4v-2Z"/>
                </svg>
                Process View
            </div>
        </div>
        <form id="planningForm" method="post" action="/order/planning">
            <input type="hidden" name="folderId" th:value="${selectedFolderId}">
            <div class="details" style="margin-top:12px;">
                <h3>Order Details</h3>
                <div class="details-grid" style="grid-template-columns:repeat(3, minmax(200px, 1fr));">
                    <div>
                        Order ID
                        <span>
                            <select id="ppOrderId" name="orderId" class="responsible-select" onchange="autoFillOrderFromSaved()">
                                <option value="" disabled selected>Select pending order</option>
                                <option th:each="oid : ${pendingOrderIds}"
                                        th:value="${oid}"
                                        th:text="${oid}"
                                        th:selected="${oid} == (${planOrderId != null} ? ${planOrderId} : (${selectedEntry != null} ? ${selectedEntry.orderId} : ''))">
                                    O2D-0000
                                </option>
                            </select>
                        </span>
                    </div>
                    <div>
                        Customer Name
                        <span>
                            <input id="ppCustomerName" type="text" placeholder="Enter customer name"
                                   th:value="${selectedEntryFields != null} ? ${selectedEntryFields['customer_name']} : ''">
                        </span>
                    </div>
                    <div>
                        Company Name
                        <span>
                            <input id="ppCompanyName" type="text" placeholder="Enter company name"
                                   th:value="${selectedEntryFields != null} ? ${selectedEntryFields['company_name']} : ''">
                        </span>
                    </div>
                </div>
                <input id="ppStartDate" name="startDate" type="hidden"
                       th:value="${planStartDate != null} ? ${planStartDate} : (${selectedEntryFields != null} ? ${selectedEntryFields['starting_date_mandatory']} : '')">
            </div>
        </form>
        <div class="table-wrap planning-table" style="margin-top:16px;">
            <table class="planning-grid">
                <thead>
                    <tr>
                        <th>Step / Process</th>
                        <th>Responsible Person</th>
                        <th>Target Date</th>
                    </tr>
                </thead>
                <tbody>
                    <tr class="folder-row" th:each="step, iter : ${processDetails}"
                        th:attr="data-days=${step.days}, data-target-type=${step.targetType}">
                        <td th:text="${step.stepProcess}">Step</td>
                        <td>
                            <select class="responsible-select">
                                <option th:each="opt : ${responsibleOptions}"
                                        th:value="${opt}"
                                        th:text="${opt}"
                                        th:selected="${opt} == ${step.responsiblePerson}">
                                    Employee
                                </option>
                            </select>
                        </td>
                        <td>
                            <input class="target-date-input" type="date">
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>
        <div style="display:flex;justify-content:flex-end;margin-top:16px;">
            <button class="btn btn-primary" type="submit" form="planningForm">Submit</button>
        </div>
    </div>
 </div>

    <div th:if="${planningBlocks != null and !planningBlocks.isEmpty()}">
        <div th:each="plan, iter : ${planningBlocks}" style="margin-top:18px;">
            <button class="folder-btn" type="button" th:attr="data-target=${'plan-' + iter.index}" onclick="togglePlanBlock(this)">
                <span class="left">
                    <svg class="icon" viewBox="0 0 24 24" aria-hidden="true">
                        <path d="M3 6a2 2 0 0 1 2-2h5l2 2h7a2 2 0 0 1 2 2v2H3V6Zm0 5h20v7a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-7Z"/>
                    </svg>
                    Planning Result
                </span>
                <span class="badge" th:text="${plan['orderId']}">Order</span>
            </button>
            <div class="section planning-block" th:attr="id=${'plan-' + iter.index}" style="display:none;margin-top:12px;">
            <div class="section-header">
                <h2>
                    <span class="title-icon">
                        <svg class="icon" viewBox="0 0 24 24" aria-hidden="true">
                            <path d="M6 3h12a2 2 0 0 1 2 2v13a3 3 0 0 1-3 3H6a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2Zm0 4v12h11a1 1 0 0 0 1-1V7H6Zm2 2h8v2H8V9Zm0 4h8v2H8v-2Z"/>
                        </svg>
                    </span>
                    Order Entry Dashboard
                </h2>
                <div class="tag">
                    <svg class="icon" viewBox="0 0 24 24" aria-hidden="true">
                        <path d="M12 2a9 9 0 1 0 9 9 9 9 0 0 0-9-9Zm4.1 7.6-4.6 5a1 1 0 0 1-1.5.1l-2.1-2.1a1 1 0 1 1 1.4-1.4l1.4 1.4 3.9-4.2a1 1 0 1 1 1.5 1.2Z"/>
                    </svg>
                    Planning Result
                </div>
            </div>
            <div class="table-wrap planning-table" style="margin-top:12px;">
                <table>
                    <thead>
                        <tr>
                            <th>Order ID</th>
                            <th>Customer Name</th>
                            <th>Company Name</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td th:text="${plan['orderId']}">-</td>
                            <td th:text="${plan['customerName']}">-</td>
                            <td th:text="${plan['companyName']}">-</td>
                        </tr>
                    </tbody>
                </table>
            </div>
            <div class="table-wrap planning-table" style="margin-top:12px;">
                <table>
                    <thead>
                        <tr>
                            <th>Step / Process</th>
                            <th>Responsible</th>
                            <th>Target Date</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr th:each="row : ${plan['rows']}">
                            <td th:text="${row['stepProcess']}">Step</td>
                            <td th:text="${row['responsiblePerson']}">Responsible</td>
                            <td th:text="${row['targetDate']}">-</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

<div id="drawerBackdrop" class="drawer-backdrop" onclick="closeDrawer()"></div>
<div id="drawer" class="drawer" aria-hidden="true">
    <h3>New Order Entry</h3>
    <p class="sub">Order Details Section</p>
    <form class="form-card" method="post" action="/order/entry">
        <input type="hidden" name="folderId" th:value="${selectedFolderId}">
        <div class="field-grid">
            <div class="field">
                <label for="orderId">Unique Order ID</label>
                <input id="orderId" name="orderId" class="readonly" type="text" readonly>
            </div>
            <div class="field" th:each="detail : ${orderDetails}"
                 th:with="key=${#strings.replace(#strings.replace(#strings.replace(#strings.toLowerCase(detail),' ','_'),'(',''),')','')}">
                <label th:text="${detail}">Field Name</label>
                <input th:attr="type=${#strings.containsIgnoreCase(detail,'date') && !detail.equalsIgnoreCase('cdd') && !detail.equalsIgnoreCase('mpd') ? 'date' : (#strings.containsIgnoreCase(detail,'quantity') ? 'number' : 'text')},
                                required=${#strings.containsIgnoreCase(detail,'start')},
                                id=${key},
                                name=${'field_' + key}"
                       th:placeholder="'Enter ' + ${detail}">
            </div>
            <div class="field"
                 th:if="${orderDetails == null || (!#lists.contains(orderDetails,'Starting Date') && !#lists.contains(orderDetails,'Starting Date (mandatory)'))}">
                <label for="starting_date_mandatory">Starting Date (mandatory)</label>
                <input id="starting_date_mandatory" name="field_starting_date_mandatory" type="date" required>
            </div>
            <div class="field">
                <label for="planning_status">Planning Status</label>
                <select id="planning_status" name="field_planning_status" required>
                    <option value="" disabled selected>Select status</option>
                    <option value="Pending">Pending</option>
                    <option value="Planned">Planned</option>
                </select>
            </div>
        </div>
        <div class="drawer-actions">
            <button class="btn btn-primary" type="submit">Save Order</button>
            <button class="btn btn-ghost" type="button" onclick="closeDrawer()">Cancel</button>
        </div>
        <div id="successMessage" class="success">
            Success! Order saved. Redirecting to Order Details for <strong id="successOrderId">-</strong>.
        </div>
    </form>
</div>
    </main>
</div>

<script>
    function generateOrderId(){
        const rand = Math.floor(1000 + Math.random() * 9000);
        return "O2D-" + rand;
    }


    function showPlanning(){
        const planning = document.getElementById("planningView");
        const entryView = document.getElementById("orderEntryView");
        const isOpen = planning.style.display === "block";
        if (isOpen) {
            planning.style.display = "none";
            entryView.style.display = "block";
            return;
        }
        entryView.style.display = "none";
        planning.style.display = "block";
        planning.scrollIntoView({behavior:"smooth"});
        updateTargetDates();
    }

    function hidePlanning(){
        const planning = document.getElementById("planningView");
        const entryView = document.getElementById("orderEntryView");
        planning.style.display = "none";
        entryView.style.display = "block";
    }

    function openRow(orderId){
        alert("Open details for " + orderId);
    }

    function toggleProfileMenu(id){
        const menu = document.getElementById(id);
        const isOpen = menu.style.display === "block";
        document.querySelectorAll(".profile-menu").forEach(m => m.style.display = "none");
        menu.style.display = isOpen ? "none" : "block";
    }

    function editProfile(){
        alert("Edit Profile clicked");
    }

    document.addEventListener("click", function(event){
        if (!event.target.closest(".profile")) {
            document.querySelectorAll(".profile-menu").forEach(m => m.style.display = "none");
        }
    });

    document.addEventListener("DOMContentLoaded", function(){
    });

    function openDrawer(){
        const drawer = document.getElementById("drawer");
        const backdrop = document.getElementById("drawerBackdrop");
        drawer.classList.add("open");
        backdrop.classList.add("open");
        document.getElementById("orderId").value = generateOrderId();
    }

    function closeDrawer(){
        document.getElementById("drawer").classList.remove("open");
        document.getElementById("drawerBackdrop").classList.remove("open");
    }

    function autoFillOrderFromSaved(){
        const orderId = (document.getElementById("ppOrderId").value || "").trim();
        const folderId = document.getElementById("savedFolderId") ? document.getElementById("savedFolderId").value : "";
        if (!orderId || !folderId) {
            return;
        }

        fetch("/order/entry?folderId=" + encodeURIComponent(folderId) + "&orderId=" + encodeURIComponent(orderId))
            .then(resp => resp.ok ? resp.json() : null)
            .then(entry => {
                if (!entry || !entry.fields) {
                    return;
                }
                const config = document.getElementById("configData");
                const fallback = (key) => config ? (config.getAttribute(key) || "") : "";
                const companyKey = findFieldKey(entry.fields, ["company", "name"]);

                setOrderField("ppCustomerName", entry.fields["customer_name"] || fallback("data-customer-name"), true);
                setOrderField("ppCompanyName", entry.fields["company_name"] || entry.fields["company"] || (companyKey ? entry.fields[companyKey] : "") || fallback("data-company-name"), true);
                setOrderField("ppRawMaterial", entry.fields["raw_material"] || fallback("data-raw-material"), true);
                setOrderField("ppQuantity", entry.fields["quantity"] || fallback("data-quantity"), true);
                setOrderField("ppCDD", entry.fields["cdd"] || fallback("data-cdd"), true);
                setOrderField("ppMPD", entry.fields["mpd"] || fallback("data-mpd"), true);
                setOrderField("ppStartDate", entry.fields["starting_date_mandatory"] || entry.fields["starting_date"] || fallback("data-start-date"), true);
                updateTargetDates();
            });
    }

    function findFieldKey(fields, parts){
        if (!fields) {
            return "";
        }
        const keys = Object.keys(fields);
        return keys.find(k => parts.every(p => k.toLowerCase().includes(p))) || "";
    }


    function setOrderField(id, value, lock){
        const el = document.getElementById(id);
        if (!el) {
            return;
        }
        if (lock) {
            el.value = value || "";
        }
        el.readOnly = !!lock && el.type !== "date";
        if (el.type === "date") {
            el.disabled = !!lock;
        }
    }

    function updateTargetDates(){
        const startInput = document.getElementById("ppStartDate");
        if (!startInput) {
            return;
        }
        const startValue = startInput.value;
        document.querySelectorAll("tr.folder-row").forEach(row => {
            const targetInput = row.querySelector(".target-date-input");
            if (!targetInput) {
                return;
            }
            const targetType = (row.getAttribute("data-target-type") || "").toLowerCase();
            const days = parseInt(row.getAttribute("data-days") || "0", 10);
            if (targetType === "manual") {
                targetInput.disabled = false;
                return;
            }
            targetInput.disabled = true;
            if (!startValue || Number.isNaN(days)) {
                targetInput.value = "";
                return;
            }
            const base = new Date(startValue + "T00:00:00");
            const d = new Date(base);
            d.setDate(d.getDate() + days);
            targetInput.value = d.toISOString().slice(0,10);
        });
    }

    function togglePlanBlock(button){
        if (!button) {
            return;
        }
        const targetId = button.getAttribute("data-target");
        if (!targetId) {
            return;
        }
        const box = document.getElementById(targetId);
        if (!box) {
            return;
        }
        const isOpen = box.style.display === "block";
        box.style.display = isOpen ? "none" : "block";
        if (!isOpen) {
            box.scrollIntoView({behavior:"smooth"});
        }
    }

</script>

</body>
</html>
